<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>CakePHP &amp; AJAX</title>
        <meta name="description" content="Yoann Pigné's personal
                      website. Researcher in computer science, Networks,  dynamic
                      graphs, Mobile ad hoc Networks, Vehicular Ad hoc
                      Networks. Lecturer in CS, web services.">
        <meta name="author" content="Yoann Pigné">
        <meta name="google-site-verification" content="FKKi10AM77zJWOKffGHjTdcaOdN6HyLQSTYZu9T_M-0">
        <meta name="Robots" content="all">
        <meta name="viewport" content="width=device-width">

        <link rel="shortcut icon" href="../../favicon.ico" />

        <!-- For iPad with high-resolution Retina display running iOS ≥ 7: -->
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../images/apple-touch-icon-152x152-precomposed.png">
        <!-- For iPad with high-resolution Retina display running iOS ≤ 6: -->
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../images/apple-touch-icon-144x144-precomposed.png">
        <!-- For iPhone with high-resolution Retina display running iOS ≥ 7: -->
        <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../images/apple-touch-icon-120x120-precomposed.png">
        <!-- For iPhone with high-resolution Retina display running iOS ≤ 6: -->
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../images/apple-touch-icon-114x114-precomposed.png">
        <!-- For the iPad mini and the first- and second-generation iPad on iOS ≥ 7: -->
        <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../../images/apple-touch-icon-76x76-precomposed.png">
        <!-- For the iPad mini and the first- and second-generation iPad on iOS ≤ 6: -->
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../images/apple-touch-icon-72x72-precomposed.png">
        <!-- For non-Retina iPhone, iPod Touch, and Android 2.1+ devices: -->
        <link rel="apple-touch-icon-precomposed" href="../../apple-touch-icon-precomposed.png">



        <link rel="stylesheet" href="../../styles/42b22a2c.main.css"/>
        
            
                 <link rel="stylesheet" media="screen" href="../../bower_components/highlightjs/styles/default.css">
                <link rel="stylesheet" media="projection, print" href="../../bower_components/highlightjs/styles/tomorrow.css">
        
        

    </head>
    <body>
        <!--[if lt IE 10]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->


        <header>
            <div class="container">

	<h3 class="pull-left "><a href="/">Yoann Pigné</a></h3>
	<div class="pull-right" id="favicon"></div>
	<ul class="nav nav-pills  pull-right">
		
			
		
			
		
			
		
			
		
			
		
			
				<li><a href="../../projects/index.html">Projects </a></li>
			
		
			
		
			
				<li><a href="../../publications/index.html">Publications </a></li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
				<li><a href="../../contact/index.html">Contact </a></li>
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
		
			
				<li><a href="../index.html">Teaching </a></li>
			
		
			
				<li><a href="../../these/index.html">Ph.D. </a></li>
			
		
	</ul>
</div>

        </header>
        <div class="main">
            

<div class="page-info row">

</div>

<div class="jumbotron">
    <div class="container">
        <h1>CakePHP &amp; AJAX <small></small></h1>
        
            <ul class="text-right list-unstyled">
                
                <li>TP n°4  - Info-Web - Licence 3</li>
                
                <li>CakePKP</li>
                
                <li>AJAX</li>
                
                <li>jQuery</li>
                
            </ul>
        
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-12">
            

<h2 id="des-requ-tes-ajax-dans-une-web-app-">Des requêtes AJAX dans une web app.</h2>
<p>CakePHP est un framework coté serveur où toute la logique (Modèle, Vue et Contrôle) est gérée sur le serveur. Il est néanmoins possible de rendre les applications  plus dynamiques et d&#39;éviter les rechargements systématiques de pages.</p>
<p>Pour éviter le rechargement des pages il y a principalement 2 mécanismes mettre en œuvre :</p>
<ul>
<li>Coté <em>client</em> (dans le navigateur, en JavaScript), il faut empêcher l&#39;exécution des liens classiques et les &quot;transformer&quot; en appels asynchrones <em>XmlHttpRequest</em>. Puis il faut traiter correctement le contenu qui sera retourné par le serveur en modifiant dynamiquement la page Web (modification du DOM). </li>
<li>Coté <em>serveur</em> (en PHP), lors de la réception d&#39;une requête, il faut détecter la nature de la requête et adapter la réponse en conséquence. En effet, la requête AJAX s&#39;attend à recevoir uniquement le code nécessaire à l&#39;affichage du nouveau contenu. Elle ne s&#39;attend pas à recevoir le code d&#39;une page entière avec tout ses entêtes, ses scripts, ses styles... L&#39;idéal en terme de performance est de ne même pas envoyer de HTML mais uniquement les données nécessaires dans un format adapté (XML ou JSON). </li>
</ul>
<h2 id="cot-client">Coté client</h2>
<p><a href="http://jquery.com/">JQuery</a> est une bibliothèque JavaScript dédiée à la <strong>manipulation du DOM</strong>. La bibliothèque possède également de méthodes utilitaires pour d&#39;autres composant des navigateurs. Ainsi la manipulation des XmlHttpRequests (XHR) se fait souvent avec jQuery. Attention à ne pas croire à tore que jQuery sert à tout dès qu&#39;il s&#39;agit de javascript dans un navigateur.</p>
<h3 id="gestion-des-clics">Gestion des clics</h3>
<p>Afin d&#39;éviter les rechargements de page, on doit contrôler les appels de l&#39;application au serveur. Pour cela il faut empêcher le fonctionnement normal des liens dans l&#39;application et les remplacer par des appels asynchrones XHR. On utilise la fonction <code>on()</code> de jQuery qui permet d&#39;enregistrer un écouteur d&#39;événement sur des éléments du DOM. Les événements qui nous intéressent sont les clics et les éléments qui nous intéressent sont les liens de l&#39;application. </p>
<p>Puisqu&#39;il est possible que des liens dans nos pages ne soient pas liés à l&#39;application (liens externes) il convient de repérer les liens qui nous intéressent en les &quot;marquant&quot; d&#39;une classe CSS (<code>ajax</code> par exemple). </p>
<p>Le code suivant permet d&#39;écouter les clics à l&#39;échelle de toute l&#39;application en ne réagissant qu&#39;aux clics venant des éléments portant une classe <code>ajax</code>:</p>
<pre><code class="language-javascript">$(document).on(<span class="string">'click'</span>, <span class="string">'.ajax'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span>{</span>
    <span class="comment">// do something...</span>
});</code></pre>
<h3 id="xmlhttprequest">XmlHttpRequest</h3>
<p>On doit maintenant effectuer la requête à la place du lien normal en utilisant une XHR. Avec jQuery la fonction de <em>callback</em>, qui réagit aux clics, doit retourner <code>false</code> pour en empêcher le mécanisme normal de suivi du lien. On utilise la fonction <code>get()</code> de jQuery à laquelle on donne l&#39;url indiquée dans le lien qui vient d&#39;être cliqué et qui est contenue dans son champ <code>href</code> </p>
<pre><code class="language-javascript">$(document).on(<span class="string">'click'</span>, <span class="string">'.ajax'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span>{</span>
    $.get($(event.target).attr(<span class="string">'href'</span>), <span class="function"><span class="keyword">function</span> <span class="params">(data)</span>{</span>
        <span class="comment">// do something with the data</span>
    });
    <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// empêche le lien de fonctionner "normalement"</span>
});</code></pre>
<h3 id="nouveau-contenu">Nouveau contenu</h3>
<p>Une fois les données reçues par le client, il faut les insérer dans la page. On doit définir un point d&#39;entrer dans le DOM de la page et remplacer ce qui existe par le nouveau contenu. On considère ici l&#39;élément d&#39;id <code>main_content</code>. Cet élément doit exister au préalable dans la page et doit donc faire parti du <em>templete</em> de départ envoyé par le serveur (<code>app/view/Layouts/default.ctp</code> dans CakePHP). On utilise encore jQuery pour créer le nouveau DOM reçu par la requête XHR en utilisant les fonction <code>empty()</code> et <code>html()</code> :</p>
<pre><code class="language-javascript">$(document).on(<span class="string">'click'</span>, <span class="string">'.ajax'</span>, <span class="function"><span class="keyword">function</span><span class="params">(event)</span>{</span>
    $.get($(event.target).attr(<span class="string">'href'</span>), <span class="function"><span class="keyword">function</span> <span class="params">(data)</span>{</span>
        $(<span class="string">'#main_content'</span>)
                .empty()       <span class="comment">// vide le conteneur,</span>
                .html(data);   <span class="comment">// puis ajoute le nouveau contenu</span>
    });
    <span class="keyword">return</span> <span class="literal">false</span>;

});</code></pre>
<h2 id="cot-server">Coté server</h2>
<p>Le comportement par défaut de CakePHP, quand une requête est reçue, est de fabriquer une nouvelle page web complète avec l&#39;entête les liens vers les feuilles de style, le javascript, etc. Or on ne veut pas récupérer toute la page lors d&#39;une requête XHR, mais seulement le code utile de la vue demandée. </p>
<p>Pour gérer le fait qu&#39;une requête sur une application Cake PHP est de type XHR, il faut ajouter le composant <code>RequestHandler</code> à la liste des <code>components</code> du ou des contrôleurs concernés. </p>
<pre><code class="language-php"><span class="preprocessor">&lt;?php</span>
<span class="class"><span class="keyword">class</span> <span class="title">AdvertsController</span> <span class="keyword">extends</span> <span class="title">AppController</span> {</span>
    <span class="keyword">public</span> <span class="variable">$helpers</span> = <span class="keyword">array</span>(<span class="string">'Html'</span>, <span class="string">'Form'</span>);
    <span class="keyword">public</span> <span class="variable">$components</span> = <span class="keyword">array</span>(<span class="string">'Session'</span>, <span class="string">'RequestHandler'</span>);
    <span class="comment">// ...</span></code></pre>
<p>Quand il est activé, le composant <code>requestHandler</code> détecte les requêtes XHR et supprime le <em>layout</em> par défaut, revoyant ainsi uniquement ce que la vue associée au contrôleur a généré. </p>
<h1 id="travail-demand-">Travail demandé</h1>
<p>On souhaite reprendre la Web App des cafés de Paris a un euro pour la rendre &quot;AJAX&quot;.</p>
<h2 id="partie-1-modification-de-l-application">Partie 1 : Modification de l&#39;application</h2>
<p>Il est demandé de reprendre votre webapp sur les &quot;cafés de Paris a un euro&quot; et de rendre cette application &quot;AJAX&quot; en remplaçant tout les liens avec le mécanisme décrit ci-dessus. </p>
<h2 id="partie-2-historique-de-navigation">Partie 2 : Historique de Navigation</h2>
<p>Il y à quelques incohérences avec notre application ainsi modifiée. En effet un clic sur un lien nous emmène à la page souhaité mais cela n&#39;est pas répercuté dans l&#39;URL du navigateur. Cela est en contradiction avec les règles des Web Services et des API REST qui, à chaque service, définissent une URL unique. </p>
<p>Depuis HTML5 l&#39;historique de navigation d&#39;un navigateur peut être géré et manipulé en javascript. </p>
<p>Il vous ai demandé de gérer les URL de votre application et donc de mettre ajour l&#39;historique de navigation  lors d&#39;une requête XHR  avec l&#39;objet HTML5 <code>history</code>. Voir la documentation sur le site <a href="https://developer.mozilla.org/fr/docs/Web/Guide/DOM/Manipuler_historique_du_navigateur">Mozilla Developer Network</a>.</p>
<h2 id="partie-3-moteurs-de-template-cot-client">Partie 3 :  Moteurs de template coté client</h2>
<p>Un second inconvénient à la technique précédente est que le nouveau contenu est inséré à un endroit prédéfini de la page. On ne peut pas facilement utiliser une partie du nouveau contenu dans un cadre puis une autre partie de ce contenu dans un autre élément. Un moyen de contourner cette  limitation est de  déporter la construction du code HTMl (ce que font les vues de CakePHP) vers le navigateur. </p>
<p>Ainsi on ne souhaitera plus produire du HTML coté serveur puis l&#39;envoyer au client pour qu&#39;il l&#39;affiche. En revanche on va vouloir envoyer uniquement les données nécessaires dans un format approprié (XML ou JSON) et laisser le client produire les éléments du DOM. </p>
<p>Pour envoyer des données JSON plutôt que du HTML en réponse à une XHR, une vue utilisera la méthode <code>is()</code> du requestHandler pour identifier la nature de la requête et la fonction <code>json_encode()</code> pour encoder les données a envoyer:</p>
<pre><code class="language-php"><span class="preprocessor">&lt;?php</span>
<span class="keyword">if</span> (<span class="variable">$this</span>-&gt;request-&gt;is(<span class="string">'ajax'</span>)) { <span class="comment">// si c'est une XHR</span>
    <span class="keyword">echo</span> json_encode(<span class="variable">$advert</span>);
}
<span class="keyword">else</span> { <span class="comment">// si c'est une requête classique</span>
<span class="preprocessor">?&gt;</span>
    &lt;article&gt;
    &lt;h2&gt;<span class="preprocessor">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$advert</span>[<span class="string">'Advert'</span>][<span class="string">'title'</span>];<span class="preprocessor">?&gt;</span>&lt;/h2&gt;
    &lt;!-- ... --&gt;
<span class="preprocessor">&lt;?php</span>
}
<span class="preprocessor">?&gt;</span></code></pre>
<p>Coté client on utilise la méthode <code>getJSON()</code> de jQuery pour récupérer des objets JavaScript. On utilisera un moteur de template coté client comme par exemple <a href="https://github.com/janl/mustache.js">Mustache</a> : </p>
<pre><code class="language-javascript"><span class="keyword">var</span> template: <span class="string">"&lt;article&gt;&lt;h2&gt;CakePHP &amp;amp; AJAX&lt;/h2&gt;&lt;!-- ...  --&gt;&lt;/article&gt;"</span>,
<span class="keyword">var</span> renderedTemplate = Mustache.render(template, data.Advert);
$(<span class="string">'#main_content'</span>).empty().html(renderedTemplate);</code></pre>
<p>Il vous ai demandé de mettre en place le rendu des pages du coté du client en effectuant le transport des données en JSON. </p>



        </div>
    </div>
</div>

        </div>
        <footer>
            <div class="container">
	<p>&copy; Yoann Pigné 2014</p>
</div>

        </footer>


        <script src="../../scripts/dbd26eaf.vendor.js"></script>

        
            
            <script src="../../scripts/updateHighlightClassNames.js"></script>
            <script>
                updateHighlightClassNames();
            </script>
            <script src="../../bower_components/highlightjs/highlight.pack.js"></script>
            <script>
                hljs.initHighlightingOnLoad();
            </script>
        
        
        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-20560642-1');ga('send','pageview');
        </script>

        
        <script src="../../scripts/20bdd8fe.plugins.js"></script>
</body>
</html>









